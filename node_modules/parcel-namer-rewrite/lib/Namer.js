"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _plugin = require("@parcel/plugin");

var _Config = require("./Config");

var _logger = require("@parcel/logger");

var _crypto = _interopRequireDefault(require("crypto"));

var _utils = require("@parcel/utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const CONFIG = Symbol.for('parcel-plugin-config'); // noinspection JSUnusedGlobalSymbols

var _default = new _plugin.Namer({
  config: _Config.Config | undefined,
  delegate: null,

  async name(opts) {
    const config = this.ensureConfig(opts.options, opts.logger);

    if (!config) {
      return null;
    }

    const nameFromSuper = await this.delegate.name(opts);

    if (nameFromSuper != null && !config.disable) {
      return this.rewrite(opts.bundle, opts.bundleGraph, opts.options, nameFromSuper, opts.logger);
    }

    return nameFromSuper;
  },

  ensureConfig(options, logger) {
    if (!this.config) {
      const projectRoot = options.projectRoot;
      const packageManager = options.packageManager;
      const env = options.env;
      const profiles = options.mode;
      const config = new _Config.Config();
      config.loadFromPackageFolder(projectRoot, env, profiles, logger);

      if (!config.chain) {
        throw Error('No chain namer has been found in project. Set package.json#parcel-namer-rewrite:chain to set a delegate namer ("@parcel/namer-default" by default)');
      }

      const delegatePackage = packageManager.load(config.chain, projectRoot);

      if (!delegatePackage) {
        throw Error(`'Package ${config.delegate}' is not available. Set package.json#parcel-namer-rewrite:chain to set a delegate namer ("@parcel/namer-default" by default)`);
      }

      const delegate = delegatePackage.default[CONFIG];

      if (!delegate) {
        throw Error(`Package '${config.delegate}' has been found, but it's not a namer. Set package.json#parcel-namer-rewrite:chain to set a delegate namer ("@parcel/namer-default" by default)`);
      }

      this.delegate = delegate;
      this.config = config;
    }

    return this.config;
  },

  async getBundleHash(bundle) {
    if (this.config.hashing === 'never') return '';

    if (this.config.useParcelHash && bundle.hashReference) {
      return bundle.hashReference;
    }

    if (this.config.hashing !== 'always') return '';
    let assets = [];
    bundle.traverseAssets(asset => assets.push(asset));

    let hash = _crypto.default.createHash('md5');

    for (let i = 0; i < assets.length; ++i) {
      const asset = assets[i];

      if (asset.filePath) {
        const fileHash = await (0, _utils.md5FromFilePath)(asset.fs, asset.filePath);
        hash.update([asset.filePath, fileHash].join(':'));
      }
    }

    return hash.digest('hex').substring(0, 6);
  },

  async rewrite(bundle, bundleGraph, options, superName, logger) {
    const neverHashing = this.config.hashing === 'never';

    function superNameWithoutHashReference() {
      return bundle.hashReference ? superName.replace("." + bundle.hashReference, "") : superName;
    }

    const rule = this.config.selectRule(superName);

    if (!rule) {
      return neverHashing ? superNameWithoutHashReference() : superName;
    }

    const bundleHash = await this.getBundleHash(bundle, options);
    const rewrite = superNameWithoutHashReference().replace(rule.test, rule.to).replace(/{(.?)hash(.?)}/, !neverHashing && bundleHash.length > 0 ? `$1${bundleHash}$2` : '');

    if (this.config.silent !== true) {
      logger.info({
        message: `Rewrite ${superName} -> ${rewrite}`
      });
    }

    return rewrite;
  }

});

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9OYW1lci5qcyJdLCJuYW1lcyI6WyJDT05GSUciLCJTeW1ib2wiLCJmb3IiLCJOYW1lciIsImNvbmZpZyIsIkNvbmZpZyIsInVuZGVmaW5lZCIsImRlbGVnYXRlIiwibmFtZSIsIm9wdHMiLCJlbnN1cmVDb25maWciLCJvcHRpb25zIiwibG9nZ2VyIiwibmFtZUZyb21TdXBlciIsImRpc2FibGUiLCJyZXdyaXRlIiwiYnVuZGxlIiwiYnVuZGxlR3JhcGgiLCJwcm9qZWN0Um9vdCIsInBhY2thZ2VNYW5hZ2VyIiwiZW52IiwicHJvZmlsZXMiLCJtb2RlIiwibG9hZEZyb21QYWNrYWdlRm9sZGVyIiwiY2hhaW4iLCJFcnJvciIsImRlbGVnYXRlUGFja2FnZSIsImxvYWQiLCJkZWZhdWx0IiwiZ2V0QnVuZGxlSGFzaCIsImhhc2hpbmciLCJ1c2VQYXJjZWxIYXNoIiwiaGFzaFJlZmVyZW5jZSIsImFzc2V0cyIsInRyYXZlcnNlQXNzZXRzIiwiYXNzZXQiLCJwdXNoIiwiaGFzaCIsImNyeXB0byIsImNyZWF0ZUhhc2giLCJpIiwibGVuZ3RoIiwiZmlsZVBhdGgiLCJmaWxlSGFzaCIsImZzIiwidXBkYXRlIiwiam9pbiIsImRpZ2VzdCIsInN1YnN0cmluZyIsInN1cGVyTmFtZSIsIm5ldmVySGFzaGluZyIsInN1cGVyTmFtZVdpdGhvdXRIYXNoUmVmZXJlbmNlIiwicmVwbGFjZSIsInJ1bGUiLCJzZWxlY3RSdWxlIiwiYnVuZGxlSGFzaCIsInRlc3QiLCJ0byIsInNpbGVudCIsImluZm8iLCJtZXNzYWdlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxNQUFNLEdBQUdDLE1BQU0sQ0FBQ0MsR0FBUCxDQUFXLHNCQUFYLENBQWYsQyxDQUVBOztlQUNlLElBQUlDLGFBQUosQ0FBVTtBQUNyQkMsRUFBQUEsTUFBTSxFQUFFQyxpQkFBU0MsU0FESTtBQUVyQkMsRUFBQUEsUUFBUSxFQUFF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LE9BQTNCLENBQXpCO0FBQ0EsVUFBTUksT0FBTyxHQUFHb0MsNkJBQTZCLEdBQ3hDQyxPQURXLENBQ0hDLElBQUksQ0FBQ0csSUFERixFQUNRSCxJQUFJLENBQUNJLEVBRGIsRUFFWEwsT0FGVyxDQUVILGdCQUZHLEVBRWUsQ0FBQ0YsWUFBRCxJQUFpQkssVUFBVSxDQUFDZCxNQUFYLEdBQW9CLENBQXJDLEdBQTBDLEtBQUljLFVBQVcsSUFBekQsR0FBK0QsRUFGOUUsQ0FBaEI7O0FBSUEsUUFBSSxLQUFLbkQsTUFBTCxDQUFZc0QsTUFBWixLQUF1QixJQUEzQixFQUFpQztBQUM3QjlDLE1BQUFBLE1BQU0sQ0FBQytDLElBQVAsQ0FBWTtBQUNSQyxRQUFBQSxPQUFPLEVBQUcsV0FBVVgsU0FBVSxPQUFNbEMsT0FBUTtBQURwQyxPQUFaO0FBR0g7O0FBRUQsV0FBT0EsT0FBUDtBQUNIOztBQS9Gb0IsQ0FBVixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtOYW1lcn0gZnJvbSAnQHBhcmNlbC9wbHVnaW4nO1xuaW1wb3J0IHtDb25maWd9IGZyb20gXCIuL0NvbmZpZ1wiO1xuaW1wb3J0IHtQbHVnaW5Mb2dnZXJ9IGZyb20gJ0BwYXJjZWwvbG9nZ2VyJztcbmltcG9ydCBjcnlwdG8gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHttZDVGcm9tRmlsZVBhdGh9IGZyb20gXCJAcGFyY2VsL3V0aWxzXCI7XG5cbmNvbnN0IENPTkZJRyA9IFN5bWJvbC5mb3IoJ3BhcmNlbC1wbHVnaW4tY29uZmlnJyk7XG5cbi8vIG5vaW5zcGVjdGlvbiBKU1VudXNlZEdsb2JhbFN5bWJvbHNcbmV4cG9ydCBkZWZhdWx0IG5ldyBOYW1lcih7XG4gICAgY29uZmlnOiBDb25maWcgfCB1bmRlZmluZWQsXG4gICAgZGVsZWdhdGU6IG51bGwsXG5cbiAgICBhc3luYyBuYW1lKG9wdHM6IHsgYnVuZGxlOiBCdW5kbGUsIGJ1bmRsZUdyYXBoOiB7fSwgb3B0aW9uczoge30sIGxvZ2dlcjogUGx1Z2luTG9nZ2VyIH0pIHtcbiAgICAgICAgY29uc3QgY29uZmlnID0gdGhpcy5lbnN1cmVDb25maWcob3B0cy5vcHRpb25zLCBvcHRzLmxvZ2dlcik7XG4gICAgICAgIGlmICghY29uZmlnKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5hbWVGcm9tU3VwZXIgPSBhd2FpdCB0aGlzLmRlbGVnYXRlLm5hbWUob3B0cyk7XG4gICAgICAgIGlmIChuYW1lRnJvbVN1cGVyICE9IG51bGwgJiYgIWNvbmZpZy5kaXNhYmxlKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXdyaXRlKG9wdHMuYnVuZGxlLCBvcHRzLmJ1bmRsZUdyYXBoLCBvcHRzLm9wdGlvbnMsIG5hbWVGcm9tU3VwZXIsIG9wdHMubG9nZ2VyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmFtZUZyb21TdXBlcjtcbiAgICB9LFxuXG4gICAgZW5zdXJlQ29uZmlnKG9wdGlvbnM6IHt9LCBsb2dnZXI6IFBsdWdpbkxvZ2dlcikge1xuICAgICAgICBpZiAoIXRoaXMuY29uZmlnKSB7XG4gICAgICAgICAgICBjb25zdCBwcm9qZWN0Um9vdCA9IG9wdGlvbnMucHJvamVjdFJvb3RcbiAgICAgICAgICAgIGNvbnN0IHBhY2thZ2VNYW5hZ2VyID0gb3B0aW9ucy5wYWNrYWdlTWFuYWdlclxuICAgICAgICAgICAgY29uc3QgZW52ID0gb3B0aW9ucy5lbnZcbiAgICAgICAgICAgIGNvbnN0IHByb2ZpbGVzID0gb3B0aW9ucy5tb2RlXG5cbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IG5ldyBDb25maWcoKTtcbiAgICAgICAgICAgIGNvbmZpZy5sb2FkRnJvbVBhY2thZ2VGb2xkZXIocHJvamVjdFJvb3QsIGVudiwgcHJvZmlsZXMsIGxvZ2dlcik7XG4gICAgICAgICAgICBpZiAoIWNvbmZpZy5jaGFpbikge1xuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKCdObyBjaGFpbiBuYW1lciBoYXMgYmVlbiBmb3VuZCBpbiBwcm9qZWN0LiBTZXQgcGFja2FnZS5qc29uI3BhcmNlbC1uYW1lci1yZXdyaXRlOmNoYWluIHRvIHNldCBhIGRlbGVnYXRlIG5hbWVyIChcIkBwYXJjZWwvbmFtZXItZGVmYXVsdFwiIGJ5IGRlZmF1bHQpJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGRlbGVnYXRlUGFja2FnZSA9IHBhY2thZ2VNYW5hZ2VyLmxvYWQoY29uZmlnLmNoYWluLCBwcm9qZWN0Um9vdCk7XG4gICAgICAgICAgICBpZiAoIWRlbGVnYXRlUGFja2FnZSkge1xuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKGAnUGFja2FnZSAke2NvbmZpZy5kZWxlZ2F0ZX0nIGlzIG5vdCBhdmFpbGFibGUuIFNldCBwYWNrYWdlLmpzb24jcGFyY2VsLW5hbWVyLXJld3JpdGU6Y2hhaW4gdG8gc2V0IGEgZGVsZWdhdGUgbmFtZXIgKFwiQHBhcmNlbC9uYW1lci1kZWZhdWx0XCIgYnkgZGVmYXVsdClgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZGVsZWdhdGUgPSBkZWxlZ2F0ZVBhY2thZ2UuZGVmYXVsdFtDT05GSUddO1xuICAgICAgICAgICAgaWYgKCFkZWxlZ2F0ZSkge1xuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKGBQYWNrYWdlICcke2NvbmZpZy5kZWxlZ2F0ZX0nIGhhcyBiZWVuIGZvdW5kLCBidXQgaXQncyBub3QgYSBuYW1lci4gU2V0IHBhY2thZ2UuanNvbiNwYXJjZWwtbmFtZXItcmV3cml0ZTpjaGFpbiB0byBzZXQgYSBkZWxlZ2F0ZSBuYW1lciAoXCJAcGFyY2VsL25hbWVyLWRlZmF1bHRcIiBieSBkZWZhdWx0KWApO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmRlbGVnYXRlID0gZGVsZWdhdGU7XG4gICAgICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5jb25maWc7XG4gICAgfSxcblxuICAgIGFzeW5jIGdldEJ1bmRsZUhhc2goYnVuZGxlKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5oYXNoaW5nID09PSAnbmV2ZXInKSByZXR1cm4gJyc7XG5cbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLnVzZVBhcmNlbEhhc2ggJiYgYnVuZGxlLmhhc2hSZWZlcmVuY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBidW5kbGUuaGFzaFJlZmVyZW5jZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5oYXNoaW5nICE9PSAnYWx3YXlzJykgcmV0dXJuICcnXG5cbiAgICAgICAgbGV0IGFzc2V0cyA9IFtdO1xuICAgICAgICBidW5kbGUudHJhdmVyc2VBc3NldHMoKGFzc2V0KSA9PiBhc3NldHMucHVzaChhc3NldCkpO1xuXG4gICAgICAgIGxldCBoYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ21kNScpO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFzc2V0cy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgICAgY29uc3QgYXNzZXQgPSBhc3NldHNbaV07XG4gICAgICAgICAgICBpZiAoYXNzZXQuZmlsZVBhdGgpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxlSGFzaCA9IGF3YWl0IG1kNUZyb21GaWxlUGF0aChhc3NldC5mcywgYXNzZXQuZmlsZVBhdGgpO1xuICAgICAgICAgICAgICAgIGhhc2gudXBkYXRlKFthc3NldC5maWxlUGF0aCwgZmlsZUhhc2hdLmpvaW4oJzonKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGhhc2guZGlnZXN0KCdoZXgnKS5zdWJzdHJpbmcoMCwgNik7XG4gICAgfSxcblxuICAgIGFzeW5jIHJld3JpdGUoYnVuZGxlOiB7IGlkOiBzdHJpbmcgfSwgYnVuZGxlR3JhcGg6IHt9LCBvcHRpb25zOiB7fSwgc3VwZXJOYW1lOiBzdHJpbmcsIGxvZ2dlcikge1xuICAgICAgICBjb25zdCBuZXZlckhhc2hpbmcgPSB0aGlzLmNvbmZpZy5oYXNoaW5nID09PSAnbmV2ZXInO1xuXG4gICAgICAgIGZ1bmN0aW9uIHN1cGVyTmFtZVdpdGhvdXRIYXNoUmVmZXJlbmNlKCkge1xuICAgICAgICAgICAgcmV0dXJuIGJ1bmRsZS5oYXNoUmVmZXJlbmNlXG4gICAgICAgICAgICAgICAgPyBzdXBlck5hbWUucmVwbGFjZShcIi5cIiArIGJ1bmRsZS5oYXNoUmVmZXJlbmNlLCBcIlwiKVxuICAgICAgICAgICAgICAgIDogc3VwZXJOYW1lO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcnVsZSA9IHRoaXMuY29uZmlnLnNlbGVjdFJ1bGUoc3VwZXJOYW1lKTtcbiAgICAgICAgaWYgKCFydWxlKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV2ZXJIYXNoaW5nID8gc3VwZXJOYW1lV2l0aG91dEhhc2hSZWZlcmVuY2UoKSA6IHN1cGVyTmFtZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJ1bmRsZUhhc2ggPSBhd2FpdCB0aGlzLmdldEJ1bmRsZUhhc2goYnVuZGxlLCBvcHRpb25zKTtcbiAgICAgICAgY29uc3QgcmV3cml0ZSA9IHN1cGVyTmFtZVdpdGhvdXRIYXNoUmVmZXJlbmNlKClcbiAgICAgICAgICAgIC5yZXBsYWNlKHJ1bGUudGVzdCwgcnVsZS50bylcbiAgICAgICAgICAgIC5yZXBsYWNlKC97KC4/KWhhc2goLj8pfS8sICFuZXZlckhhc2hpbmcgJiYgYnVuZGxlSGFzaC5sZW5ndGggPiAwID8gYCQxJHtidW5kbGVIYXNofSQyYCA6ICcnKTtcblxuICAgICAgICBpZiAodGhpcy5jb25maWcuc2lsZW50ICE9PSB0cnVlKSB7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyh7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYFJld3JpdGUgJHtzdXBlck5hbWV9IC0+ICR7cmV3cml0ZX1gXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXdyaXRlO1xuICAgIH1cbn0pO1xuIl19